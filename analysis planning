//get the data
//start with a small section

cd "H:\JOE\THIN"
use in 1/30 using consults3m.dta

//try to draw graphs of symptoms vs time

// need to make a variable for time before diagnosis: indexdate minus eventdate

//gen timebefore = indexdate - eventdate

gen t2 = eventdate - indexdate

hist t2, by(case)

// turns out that cases and controls are both having contacts in the month ish before index.  Note that they were matched
// on time of consultation to case +/- 21 days: actually for this graph should use that date:

//actually need to create new index date: where it is the index case for the cases and the last contact for controls:

by id, sort: egen lasttime = max(eventdate)
gen newindex = indexdate if case==1
replace newindex = lasttime if case ==0

gen time = eventdate - newindex

hist time, by(case) 

//can get times of most recent consultation types:

gen contime1 = eventdate if  consult_group1 ==1
gen contime2 = eventdate if  consult_group1 ==2
gen contime3 = eventdate if  consult_group1 ==3
gen contime4 = eventdate if  consult_group1 ==4

gen time1 = contime1 - newindex

hist time1, by(case)
// this shows most of the controls have a consult on the index day
//they were selected because of this so drop these ones:

preserve
drop if time1 ==1
hist time1, by(case)
restore

//not really a valid comparison due to the matching of the cases and controls, but shows cases were consulting less
prior to the immediate time preceeding the diagnosis.  

//reshape the data to be one line for each case
//First create a list number:
generate order = _n
//create a label y for each nth event that each child has
by id (order), sort: generate y = _n 

preserve
quietly reshape wide eventdate , i(id) j(y)
stset newindex, failure(consult_group2)
sts graph, na
restore


// to do a survival type graph need to make the data 'st'

preserve

stset eventdate, failure(consult_group2)

sts graph, na
restore

//not really the right thing to do as these are for cohorts really. 


