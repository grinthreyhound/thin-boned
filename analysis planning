//get the data
//start with a small section

cd "H:\JOE\THIN"
use in 1/100 using consults3m.dta
//or the whole thing:
//use consults3m.dta

//try to draw graphs of symptoms vs time as per Bankhead paper


//actually need to create new index date: where it is the index case for the cases and 
//the last contact for controls:

by id, sort: egen lasttime = max(eventdate)
gen newindex = indexdate if case==1
replace newindex = lasttime if case ==0


//try to show events per person time - to begin with remember that the time at risk for cases and controls is the same (15m each)
// reshape the data to be wide:

//First create a list numbers:
generate order = _n
//create a label y for each nth event that each child has
by id (order), sort: generate y = _n 
//generate a variable that is the maximum of y (i.e. the number of consultations per person)
egen z = max(y), by(id)
//tabulate this with column %
tab z case, col



//need to reset the time of entry to be index date minus 15 months

gen entrytime = indexdate - 457

//now reshape wide:
preserve
keep eventdate id z y case newindex entrytime
quietly reshape wide eventdate, i(id) j(y)
tab z case, col 
hist z, by(case)

//need to compare baseline contacts between cases and controls: 



preserve
keep eventdate id y case newindex entrytime 
quietly reshape wide eventdate, i(id) j(y)
stset entrytime, failure(eventdate1)
sts graph, by(case)
//Ok but annoying scale.  
//instead can use sts to generate a variable containning the KM survival function and plot directly
//do this later as not obvious how to get it to work...
//sts gen survevent1 = s
//sts gen surv_bycase = s, by(case)
//graph twoway line ...
restore

//counting the events per person: 

//y is a variable that counts the number of events
tab y case
tab y case, row

preserve
keep case id y newindex eventdate
quietly reshape wide eventdate, i(id) j(y)
//now have one line per id, with eventdate1 through 4
//need to generate a new variable to count the events
gen 




//Another approach: survial analysis
// to do a survival type graph need to make the data 'st'
preserve
drop if time1==0
quietly reshape wide eventdate , i(id) j(y)
stset newindex, failure(consult_group2)
sts graph, na
restore




preserve

stset eventdate, failure(consult_group2)

sts graph, na
restore

//not really the right thing to do as these are for cohorts really. 


//n.b.  deaths all after index dates:
list birthdate indexdate deathdate eventdate if deathdate!=.

