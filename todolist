//2 valid approaches: conditional poisson regression or inserting the matching set into poisson as ranom effect variable.
//though likely that accounting for matching will make little difference so can do sensitivity analysis to that effect
//Using own date confirmed as the right thing to do.  
//

//get the data
//start with a small section

cd "H:\JOE\THIN"
use in 1/100 using consultation15_ss2_CC.dta
// case is 1, control is 2

//create new index date: where it is the last contact in the record:

by id, sort: egen lasttime = max(eventdate)
format lasttime %td

//create a new entry date
gen enter = lasttime-456

//drop the index date events:
drop if lasttime==eventdate

//need a matching variable: strings not allowed, so number them: 
by id: generate mgroup = id if case_control ==1
replace mgroup = case_id if case_control ==2
egen clusterid = group(mgroup)

//need a variable for any failure:
generate failure=1
//First create a list numbers:
generate order = _n
//create a label y for each nth event that each child has
by id (order), sort: generate y = _n 
//generate a variable that is the maximum of y (i.e. the number of consultations per person)
egen z = max(y), by(id)
//tabulate this with column %
*tab z case, col

//need to compare baseline contacts between cases and controls: 
//stset the data to indicate is survival time data with multiple lines per person (specify id)
//Need to specify exit or else it terminates after first failure

//For the whole dataset only: check duration of time in study with events occuring:
*by id, sort: egen firstdate = min(eventdate)
*gen duration = lasttime - firstdate
*sum duration

//to use Xt poisson need to xtset the data: delare it to be panel data
//cant use string id so need to group this
egen numid =group(id)
preserve
xtset numid eventdate

//splitting the data into time periods: lexis expansion

//stsplit earlylate, at(5(5)282) after(enter) 

//now try poisson with random effects model applied to the matching variable: need to review ASME 11

*xtpoisson case_control, exp(clusterid) irr

xtpoisson i., i(G) //not appropriate - actually don't need to declare st first, as will break down via lexis expansion.

