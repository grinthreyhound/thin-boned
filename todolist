//2 valid approaches: conditional poisson regression or inserting the matching set into poisson as ranom effect variable.
//though likely that accounting for matching will make little difference so can do sensitivity analysis to that effect
//Using own date confirmed as the right thing to do.  
//

//get the data
//start with a small section

cd "H:\JOE\THIN"
use in 1/10 using consultation15_ss2_CC.dta
// case is 1, control is 2

//create new index date: where it is the last contact in the record:

by id, sort: egen lasttime = max(eventdate)
format lasttime %td
//need to reset the time of entry to be index date minus 15 months, format as a date and
//use the order to generate a variable for a failure
gen enter = lasttime - 456
format enter %td 
generate order = _n

//need a matching variable: strings not allowed, so number them, remember _N not _n (which just counts them)
generate mgroup = id if case_control ==1
replace mgroup = case_id if case_control ==2
bysort mgroup: generate G=_N


//need to compare baseline contacts between cases and controls: 
//stset the data to indicate is survival time data with multiple lines per person (specify id)
//Need to specify exit or else it terminates after first failure

//For the whole dataset only: check duration of time in study with events occuring:
*by id, sort: egen firstdate = min(eventdate)
*gen duration = lasttime - firstdate
*sum duration

preserve
stset eventdate, id(id) fail(order) exit(time .) origin(enter) scale(1)

//splitting the data into time periods: lexis expansion

stsplit earlylate, at(5(5)282) after(enter) 

//now try poisson with random effects model applied to the matching

xtpoisson i., i(G) //not appropriate - actually don't need to declare st first, as will break down via lexis expansion.

